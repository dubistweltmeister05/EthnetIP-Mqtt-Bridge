{% extends "base.html" %}

{% block title %}Configuration - EtherNet/IP to MQTT Bridge{% endblock %}

{% block content %}
<div class="config-page">
    <h2>Configuration</h2>
    
    <form id="config-form">
        <div class="form-section">
            <h3>MQTT Settings</h3>
            <div class="form-group">
                <label for="mqtt_broker">Broker Address:</label>
                <input type="text" id="mqtt_broker" name="mqtt_broker" value="{{ config.mqtt.broker }}" required>
            </div>
            
            <div class="form-group">
                <label for="mqtt_port">Port:</label>
                <input type="number" id="mqtt_port" name="mqtt_port" value="{{ config.mqtt.port }}" required>
            </div>
            
            <div class="form-group">
                <label for="mqtt_client_id">Client ID:</label>
                <input type="text" id="mqtt_client_id" name="mqtt_client_id" value="{{ config.mqtt.client_id }}" required>
            </div>
            
            <div class="form-group">
                <label for="mqtt_topic_base">Topic Base:</label>
                <input type="text" id="mqtt_topic_base" name="mqtt_topic_base" value="{{ config.mqtt.topic_base }}" required>
            </div>
            
            <div class="form-group">
                <label for="mqtt_username">Username (optional):</label>
                <input type="text" id="mqtt_username" name="mqtt_username" value="{{ config.mqtt.username }}">
            </div>
            
            <div class="form-group">
                <label for="mqtt_password">Password (optional):</label>
                <input type="password" id="mqtt_password" name="mqtt_password" value="{{ config.mqtt.password }}">
            </div>
            
            <div class="form-group">
                <label for="mqtt_qos">QoS:</label>
                <select id="mqtt_qos" name="mqtt_qos">
                    <option value="0" {{ 'selected' if config.mqtt.qos == 0 else '' }}>0 - At most once</option>
                    <option value="1" {{ 'selected' if config.mqtt.qos == 1 else '' }}>1 - At least once</option>
                    <option value="2" {{ 'selected' if config.mqtt.qos == 2 else '' }}>2 - Exactly once</option>
                </select>
            </div>
            
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" id="mqtt_retain" name="mqtt_retain" {{ 'checked' if config.mqtt.retain else '' }}>
                    Retain Messages
                </label>
            </div>
        </div>
        
        <div class="form-section">
            <h3>PLC Settings</h3>
            <div class="form-group">
                <label for="plc_ip_address">IP Address:</label>
                <input type="text" id="plc_ip_address" name="plc_ip_address" value="{{ config.ethernetip.ip_address }}" required>
            </div>
            
            <div class="form-group">
                <label for="plc_tags">Tags (comma-separated):</label>
                <textarea id="plc_tags" name="plc_tags" rows="4" required>{{ config.ethernetip.tags|join(', ') }}</textarea>
                <small>Example: Temperature, Pressure, FlowRate, Status</small>
            </div>
        </div>
        
        <div class="form-section">
            <h3>General Settings</h3>
            <div class="form-group">
                <label for="poll_interval">Poll Interval (seconds):</label>
                <input type="number" id="poll_interval" name="poll_interval" value="{{ config.poll_interval }}" min="1" required>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Configuration</button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('config-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/config', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Configuration saved successfully!');
            window.location.href = '/';
        } else {
            alert('Failed to save configuration: ' + data.message);
        }
    } catch (error) {
        alert('Error saving configuration: ' + error);
    }
});
</script>
{% endblock %}
